name: Check Plugin Updates

on:
  schedule:
    # Kjør hver mandag kl 09:00 UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Manuell kjøring

jobs:
  check-updates:
    runs-on: ubuntu-latest
    steps:
      - name: Check for plugin updates
        id: check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ssh.bleikoya.net
          username: bleikoya.net
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          capture_stdout: true
          script: |
            cd /www
            wp plugin list --update=available --format=csv --fields=name,version,update_version

      - name: Send notification if updates available
        if: steps.check.outputs.stdout != ''
        run: |
          UPDATES="${{ steps.check.outputs.stdout }}"
          if [ -n "$UPDATES" ] && [ "$UPDATES" != "name,version,update_version" ]; then
            curl -H "Title: Plugin-oppdateringer tilgjengelig" \
                 -H "Tags: package" \
                 -d "$UPDATES" \
                 ntfy.sh/${{ secrets.NTFY_TOPIC }}
          fi
