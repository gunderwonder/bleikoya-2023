name: Check Plugin Updates

on:
  schedule:
    # Kjør hver mandag kl 09:00 UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Manuell kjøring

jobs:
  check-updates:
    runs-on: ubuntu-latest
    steps:
      - name: Check for plugin updates and notify
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ssh.bleikoya.net
          username: bleikoya.net
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: NTFY_TOPIC
          script: |
            cd /www
            UPDATES=$(wp plugin list --update=available --format=csv --fields=name,version,update_version)

            # Sjekk om det finnes oppdateringer (mer enn bare header-linjen)
            LINE_COUNT=$(echo "$UPDATES" | wc -l)
            if [ "$LINE_COUNT" -gt 1 ]; then
              curl -H "Title: Plugin-oppdateringer tilgjengelig" \
                   -H "Tags: package" \
                   -d "$UPDATES" \
                   ntfy.sh/$NTFY_TOPIC
            fi
        env:
          NTFY_TOPIC: ${{ secrets.NTFY_TOPIC }}
