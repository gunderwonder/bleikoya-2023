name: Deploy to bleikoya.net

on:
  workflow_run:
    workflows: ["Tests"]
    types:
      - completed
    branches:
      - main

jobs:
  deploy:
    # Only deploy if tests passed
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ssh.bleikoya.net
          username: bleikoya.net
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script_stop: true
          script: |
            cd /www/wp-content/themes/bleikoya-2023
            git pull
            composer install --no-dev --optimize-autoloader

      - name: Send notification
        if: always()
        env:
          COMMIT_MSG: ${{ github.event.head_commit.message }}
          NTFY_TOPIC: ${{ secrets.NTFY_TOPIC }}
        run: |
          # Use only first line of commit message
          SUBJECT=$(echo "$COMMIT_MSG" | head -n 1)
          if [ "${{ job.status }}" = "success" ]; then
            curl -d "Deploy fullf√∏rt: $SUBJECT" "ntfy.sh/$NTFY_TOPIC"
          else
            curl -H "Priority: high" -H "Tags: warning" -d "Deploy FEILET: $SUBJECT" "ntfy.sh/$NTFY_TOPIC"
          fi
# Test 1765052211
