name: Deploy Agent to fly.io

on:
  push:
    branches: [main]
    paths:
      - 'agent/**'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy to fly.io
        working-directory: agent
        run: flyctl deploy --remote-only
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Send notification
        if: always()
        env:
          NTFY_TOPIC: ${{ secrets.NTFY_TOPIC }}
        run: |
          SUBJECT=$(echo "${{ github.event.head_commit.message }}" | head -n 1)
          if [ "${{ job.status }}" = "success" ]; then
            curl -d "Agent deploy OK: $SUBJECT" "ntfy.sh/$NTFY_TOPIC"
          else
            curl -H "Priority: high" -H "Tags: warning" \
              -d "Agent deploy FEILET: $SUBJECT" "ntfy.sh/$NTFY_TOPIC"
          fi
